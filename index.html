<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contabilidade - SincronizaÃ§Ã£o Inteligente</title>
    <style>
        :root { --primary: #2c3e50; --income: #27ae60; --expense: #e74c3c; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; color: #333; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .card { padding: 20px; border-radius: 10px; color: white; text-align: center; }
        .income-card { background: var(--income); }
        .expense-card { background: var(--expense); }
        .balance-card { background: var(--primary); }
        .forms-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .form-box { padding: 15px; border-radius: 10px; border: 1px solid #eee; }
        .form-box.in { border-top: 5px solid var(--income); background: #f0fff4; }
        .form-box.out { border-top: 5px solid var(--expense); background: #fff5f5; }
        .grid-inputs { display: flex; flex-direction: column; gap: 8px; }
        .grid-row { display: flex; gap: 5px; }
        input, button { padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px; }
        button { cursor: pointer; font-weight: bold; border: none; transition: 0.2s; }
        .btn-add-in { background: var(--income); color: white; }
        .btn-add-out { background: var(--expense); color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; }
        th { text-align: left; padding: 12px; border-bottom: 2px solid #eee; background: #fafafa; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        .editable { cursor: pointer; padding: 2px 4px; border-radius: 4px; border-bottom: 1px dashed #ccc; }
        .editable:hover { background: #ffffcc; }
        .tag-p { background: #34495e; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; }
        .btn-del { background: none; color: #e74c3c; font-size: 1.2em; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div style="display:flex; justify-content: flex-end; gap:10px; margin-bottom:15px;">
        <button onclick="exportData()" style="background:#3498db; color:white; padding:5px 10px;">ðŸ“¥ Backup</button>
        <button onclick="document.getElementById('fInput').click()" style="background:#95a5a6; color:white; padding:5px 10px;">ðŸ“¤ Restaurar</button>
        <input type="file" id="fInput" style="display:none" onchange="importData(event)">
    </div>

    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>Fluxo Sincronizado</h2>
        <input type="month" id="filter-date" onchange="updateUI()">
    </div>

    <div class="dashboard">
        <div class="card income-card"><span>Entradas (MÃªs)</span><br><strong id="display-income">R$ 0,00</strong></div>
        <div class="card expense-card"><span>SaÃ­das (MÃªs)</span><br><strong id="display-expense">R$ 0,00</strong></div>
        <div class="card balance-card"><span>Saldo Geral</span><br><strong id="display-balance">R$ 0,00</strong></div>
    </div>

    <div class="forms-container">
        <div class="form-box in" id="form-income">
            <h3>ðŸ’° Entrada</h3>
            <div class="grid-inputs">
                <input type="text" id="in-desc" placeholder="Nome da Entrada">
                <div class="grid-row">
                    <input type="number" id="in-amount" placeholder="Valor R$" style="flex:1">
                    <input type="date" id="in-date" style="flex:1">
                </div>
                <button class="btn-add-in" onclick="addItem('income')">Adicionar</button>
            </div>
        </div>

        <div class="form-box out" id="form-expense">
            <h3>ðŸ’¸ Gasto / Parcela</h3>
            <div class="grid-inputs">
                <input type="text" id="out-desc" placeholder="Nome do Gasto">
                <div class="grid-row">
                    <input type="number" id="out-amount" placeholder="Valor TOTAL R$" style="flex:2">
                    <input type="number" id="out-inst" placeholder="Qtd Parc." value="1" style="flex:1">
                </div>
                <input type="date" id="out-date">
                <button class="btn-add-out" onclick="addItem('expense')">Adicionar</button>
            </div>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>Data</th>
                <th>Nome</th>
                <th>Parcelas</th>
                <th>Valor Total</th>
                <th>Valor Parcela</th>
                <th>Saldo ApÃ³s</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="transaction-list"></tbody>
    </table>
</div>

<script>
    const now = new Date();
    document.getElementById('filter-date').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    document.querySelectorAll('input[type="date"]').forEach(i => i.valueAsDate = new Date());

    let transactions = JSON.parse(localStorage.getItem('finances_v10')) || [];

    document.getElementById('form-income').addEventListener('keypress', (e) => { if(e.key === 'Enter') addItem('income'); });
    document.getElementById('form-expense').addEventListener('keypress', (e) => { if(e.key === 'Enter') addItem('expense'); });

    function addItem(type) {
        const prefix = type === 'income' ? 'in-' : 'out-';
        const desc = document.getElementById(prefix + 'desc').value;
        const amountTotal = parseFloat(document.getElementById(prefix + 'amount').value);
        const dateVal = document.getElementById(prefix + 'date').value;
        const instals = type === 'expense' ? parseInt(document.getElementById('out-inst').value) || 1 : 1;

        if (!desc || isNaN(amountTotal) || !dateVal) return alert("Preencha tudo!");

        const groupId = Date.now();
        const baseDate = new Date(dateVal + 'T00:00:00');

        for (let i = 0; i < instals; i++) {
            const nextD = new Date(baseDate);
            nextD.setMonth(baseDate.getMonth() + i);
            transactions.push({
                id: groupId + i,
                groupId: instals > 1 ? groupId : null,
                desc: desc,
                currentP: i + 1,
                totalP: instals,
                totalValue: amountTotal,
                amount: amountTotal / instals,
                date: nextD.toISOString().split('T')[0],
                type: type
            });
        }
        save();
        document.getElementById(prefix + 'desc').value = '';
        document.getElementById(prefix + 'amount').value = '';
        document.getElementById(prefix + 'desc').focus();
    }

    function editField(id, field) {
        const index = transactions.findIndex(t => t.id === id);
        const item = transactions[index];
        let newVal = prompt(`Editar ${field}:`, item[field]);
        
        if (newVal === null || newVal === "") return;

        if (field === 'totalValue' || field === 'totalP') {
            const vTotal = field === 'totalValue' ? parseFloat(newVal) : item.totalValue;
            const qParc = field === 'totalP' ? parseInt(newVal) : item.totalP;
            const gId = item.groupId;

            if (!gId) { // Item Ãºnico
                item.totalValue = vTotal;
                item.amount = vTotal;
                item.totalP = 1;
            } else { // Sincronizar Grupo
                const baseItem = transactions.find(t => t.groupId === gId);
                const baseDate = new Date(baseItem.date + 'T00:00:00');
                
                // Remove o grupo antigo e recria com novos valores
                transactions = transactions.filter(t => t.groupId !== gId);
                for (let i = 0; i < qParc; i++) {
                    const nextD = new Date(baseDate);
                    nextD.setMonth(baseDate.getMonth() + i);
                    transactions.push({
                        id: gId + i,
                        groupId: gId,
                        desc: item.desc,
                        currentP: i + 1,
                        totalP: qParc,
                        totalValue: vTotal,
                        amount: vTotal / qParc,
                        date: nextD.toISOString().split('T')[0],
                        type: item.type
                    });
                }
            }
        } else if (field === 'amount') {
            item.amount = parseFloat(newVal);
        } else {
            item[field] = newVal;
        }
        save();
    }

    function deleteItem(id, groupId) {
        if (!groupId) {
            if(confirm("Excluir item?")) transactions = transactions.filter(t => t.id !== id);
        } else {
            const c = confirm("OK: Excluir TODO o grupo.\nCancelar: Excluir APENAS esta parcela.");
            if (c) transactions = transactions.filter(t => t.groupId !== groupId);
            else transactions = transactions.filter(t => t.id !== id);
        }
        save();
    }

    function save() {
        localStorage.setItem('finances_v10', JSON.stringify(transactions));
        updateUI();
    }

    function updateUI() {
        const list = document.getElementById('transaction-list');
        const fMonth = document.getElementById('filter-date').value;
        list.innerHTML = '';
        let tin = 0, tout = 0, runningB = 0;

        const sorted = transactions.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        sorted.forEach(t => {
            const isIn = t.type === 'income';
            if (isIn) runningB += t.amount; else runningB -= t.amount;

            if (t.date.startsWith(fMonth)) {
                if (isIn) tin += t.amount; else tout += t.amount;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="editable" onclick="editField(${t.id}, 'date')">${t.date.split('-').reverse().slice(0,2).join('/')}</td>
                    <td class="editable" onclick="editField(${t.id}, 'desc')"><strong>${t.desc}</strong></td>
                    <td class="editable" onclick="editField(${t.id}, 'totalP')">${t.totalP > 1 ? `<span class="tag-p">${t.currentP} de ${t.totalP}</span>` : 'Ãšnica'}</td>
                    <td class="editable" onclick="editField(${t.id}, 'totalValue')">R$ ${(t.totalValue || t.amount).toFixed(2)}</td>
                    <td class="editable" style="color:${isIn ? 'green' : 'red'}; font-weight:bold" onclick="editField(${t.id}, 'amount')">R$ ${t.amount.toFixed(2)}</td>
                    <td style="font-weight:bold">R$ ${runningB.toFixed(2)}</td>
                    <td><button class="btn-del" onclick="deleteItem(${t.id}, ${t.groupId})">âœ–</button></td>
                `;
                list.appendChild(row);
            }
        });
        document.getElementById('display-income').innerText = `R$ ${tin.toFixed(2)}`;
        document.getElementById('display-expense').innerText = `R$ ${tout.toFixed(2)}`;
        document.getElementById('display-balance').innerText = `R$ ${runningB.toFixed(2)}`;
    }

    function exportData() {
        const blob = new Blob([JSON.stringify(transactions)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'backup_financeiro.json';
        a.click();
    }

    function importData(e) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            transactions = JSON.parse(ev.target.result);
            save();
        };
        reader.readAsText(e.target.files[0]);
    }

    updateUI();
</script>
</body>
</html>